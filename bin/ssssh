#! /usr/bin/env ruby

require "aws-sdk-core"
require "base64"
require "clamp"
require "logger"
require "ssssh/version"

Clamp do

  option ["--region"], "REGION", "AWS region",
         :environment_variable => "AWS_REGION"
  option "--access-key", "KEY", "AWS access key",
         :environment_variable => "AWS_ACCESS_KEY_ID",
         :attribute_name => :access_key_id
  option "--secret-key", "KEY", "AWS secret key",
         :environment_variable => "AWS_SECRET_ACCESS_KEY",
         :attribute_name => :secret_access_key
  option "--session-token", "KEY", "AWS security token",
         :environment_variable => "AWS_SECURITY_TOKEN",
         :attribute_name => :session_token

  option "--debug", :flag, "enable debugging"

  option "--version", :flag, "display version" do
    puts "ssssh-#{Ssssh::VERSION}"
    exit 0
  end

  subcommand "encrypt", "Encrypt STDIN" do

    parameter "KEY_ID", "KMS key-id"
    parameter "[PLAINTEXT]", "plaintext", :default => "STDIN"

    def execute
      puts Base64.encode64(encrypt(plaintext, key_id))
    end

    private

    def default_plaintext
      $stdin.read
    end

  end

  subcommand "decrypt", "Decrypt STDIN" do

    parameter "[CIPHERTEXT]", "encoded ciphertext", :default => "STDIN"

    def execute
      puts decrypt(Base64.decode64(ciphertext))
    end

    private

    def default_ciphertext
      $stdin.read
    end

  end

  protected

  def default_region
    ENV["AWS_REGION"] || ENV["AWS_DEFAULT_REGION"]
  end

  def logger
    @logger ||= ::Logger.new($stderr).tap do |logger|
      logger.level = (debug? ? ::Logger::DEBUG : ::Logger::INFO)
    end
  end

  def aws_config
    {
      :access_key_id => access_key_id,
      :secret_access_key => secret_access_key,
      :session_token => session_token,
      :region => region,
      :logger => logger, :log_level => :debug
    }.reject { |k,v| v.nil? || v == "" }
  end

  def with_kms
    yield Aws::KMS::Client.new(aws_config)
  rescue Aws::KMS::Errors::ServiceError => e
    signal_error(e.message, :status => 9)
  end

  def encrypt(plaintext, key_id)
    with_kms do |kms|
      kms.encrypt(:key_id => key_id, :plaintext => plaintext).ciphertext_blob
    end
  end

  def decrypt(ciphertext)
    with_kms do |kms|
      kms.decrypt(:ciphertext_blob => ciphertext).plaintext
    end
  end

end
